Martin Escardo, 5th December 2025.

In any 1-topos, products of free lifting algebras are themselves
free. This result seems to be new.

\begin{code}

{-# OPTIONS --safe --without-K #-}

\end{code}

This file generalizes the following file, in a more or less
straightforward way, whose result also seem to be new, which shows
that powers of Î© are free lifting algebras.

\begin{code}

import Lifting.PowersOfOmegaAreFreeAlgebras

\end{code}

Therefore we have decided to remove most of the discussion, to avoid
repetition. So readers who wish to understand the motivation for
proving this, and how the proof here works, are advised to first look
at the above file.

\begin{code}

open import MLTT.Spartan
open import UF.FunExt
open import UF.Subsingletons
open import UF.PropTrunc
open import UF.Sets

module Lifting.ProductsOfFreeAlgebrasAreFree
        (fe       : Fun-Ext)
        (pe       : Prop-Ext)
        (pt       : propositional-truncations-exist)
        (ğ“£ ğ“¤      : Universe)
        (X        : ğ“£ Ì‡ )
        (K        : X â†’ ğ“¤ Ì‡ )
        (K-is-set : (x : X) â†’ is-set (K x))
       where

\end{code}

The sets K x are the generators for the free algebras of which we will
take the product, which replace Î© â‰ƒ ğ“› ğŸ™ in the file mentioned above.
So, to recover the results of that file, take K _ = ğŸ™.

\begin{code}

open import Lifting.Construction ğ“£
open import Lifting.Algebras ğ“£
open import Lifting.Identity ğ“£
open import UF.Embeddings
open import UF.Equiv
open import UF.Logic
open import UF.Sets-Properties
open import UF.Subsingletons-FunExt
open import UF.Subsingletons-Properties
open import UF.SubtypeClassifier-Properties
open import UF.SubtypeClassifier renaming (Î© to Î©-of-universe)

private
 ğ“£âº = ğ“£ âº

 Î© : ğ“£âº Ì‡
 Î© = Î©-of-universe ğ“£

 fe' : FunExt
 fe' ğ“¤ ğ“¥ = fe {ğ“¤} {ğ“¥}

open PropositionalTruncation pt

ğ“›K : (x : X) â†’ ğ“›-alg (ğ“› (K x))
ğ“›K x = canonical-free-algebra
 where
  open free-algebras-in-the-category-of-sets pe fe (K x) (K-is-set x)

âˆ‘ : (x : X) {p : Î©} â†’ (p holds â†’ ğ“› (K x)) â†’ ğ“› (K x)
âˆ‘ x {p} = ğ“›-alg-structure-map (ğ“›K x) (holds-is-prop p)

A : ğ“£âº âŠ” ğ“¤ Ì‡
A = (x : X) â†’ ğ“› (K x)

A-is-set : is-set A
A-is-set = Î -is-set fe (Î» (x : X) â†’ ğ“›-is-set fe fe pe (K-is-set x))

\end{code}

We denote by ğ“ the lifting structure on the product A of the free
algebras ğ“› (K x). Our objective is to show that A equipped with ğ“ is a
an algebra freely generated by a suitable set G of generators defined
below.

\begin{code}

ğ“ : ğ“›-alg A
ğ“ = Î -is-alg fe (Î» x â†’ ğ“› (K x)) ğ“›K

âˆ : extension-op A
âˆ = ğ“›-alg-structure-map ğ“

is-pos : A â†’ ğ“£ Ì‡
is-pos a = âˆƒ x ê‰ X , is-defined (a x)

being-pos-is-prop : (a : A) â†’ is-prop (is-pos a)
being-pos-is-prop a = âˆƒ-is-prop

G : ğ“£âº âŠ” ğ“¤ Ì‡
G = Î£ a ê‰ A , is-pos a

G-is-set : is-set G
G-is-set = Î£-is-set A-is-set (Î» (a : A) â†’ props-are-sets (being-pos-is-prop a))

Î¹ : G â†’ A
Î¹ = prâ‚

Î¹-is-pos : (g : G) â†’ is-pos (Î¹ g)
Î¹-is-pos = prâ‚‚

Î¹-is-embedding : is-embedding Î¹
Î¹-is-embedding = prâ‚-is-embedding being-pos-is-prop

open free-algebras-in-the-category-of-sets pe fe G G-is-set

ğ“›G : ğ“›-alg (ğ“› G)
ğ“›G = canonical-free-algebra

h : ğ“› G â†’ A
h = ğ“›-extension A-is-set ğ“ Î¹

h-explicitly : (l@(P , Ï† , i) : ğ“› G)
             â†’ h l ï¼ Î» x â†’ âˆ‘ x (Î» (p : P) â†’ Î¹ (Ï† p) x)
h-explicitly l = by-definition

h-is-hom : is-hom ğ“›G ğ“ h
h-is-hom = ğ“›-extension-is-hom A-is-set ğ“ Î¹

h-extends-Î¹ : h âˆ˜ Î· âˆ¼ Î¹
h-extends-Î¹ = ğ“›-extension-extends A-is-set ğ“ Î¹

\end{code}

In the remainder of this file we show that h has a two-sided inverse
hâ»Â¹ that is an algebra homomomorphism, from which is follows that the
product algebra (A , ğ“) is freely generated by G.

\begin{code}

hâ»Â¹ : A â†’ ğ“› G
hâ»Â¹ a = is-pos a , (Î» (i : is-pos a) â†’ a , i) , being-pos-is-prop a

hâ»Â¹-is-section : h âˆ˜ hâ»Â¹ âˆ¼ id
hâ»Â¹-is-section a =
 h (hâ»Â¹ a)                            ï¼âŸ¨ h-explicitly (hâ»Â¹ a) âŸ©
 (Î» x â†’ âˆ‘ x (Î» (_ : is-pos a) â†’ a x)) ï¼âŸ¨ I âŸ©
 a                                    âˆ
  where
   I = dfunext fe (Î» x â†’ from-â‹ pe fe fe
                          ((prâ‚‚ ,
                            (Î» (d : is-defined (a x)) â†’ âˆ£ x , d âˆ£ , d)) ,
                          (Î» _ â†’ refl)))

hâ»Â¹-is-retraction : hâ»Â¹ âˆ˜ h âˆ¼ id
hâ»Â¹-is-retraction l@(P , Ï† , i) = V
 where
  I : (âˆƒ x ê‰ X , Î£ p ê‰ P , is-defined (Î¹ (Ï† p) x)) â†’ P
  I = âˆ¥âˆ¥-rec i (Î» (x , p , h) â†’ p)

  II : P â†’ âˆƒ x ê‰ X , Î£ p ê‰ P , is-defined(Î¹ (Ï† p) x)
  II p = âˆ¥âˆ¥-rec âˆƒ-is-prop (Î» (x , h) â†’ âˆ£ x , p , h âˆ£) e
   where
    e : âˆƒ x ê‰ X , is-defined(Î¹ (Ï† p) x)
    e = Î¹-is-pos (Ï† p)

  III : {e : âˆƒ x ê‰ X , Î£ p ê‰ P , is-defined(Î¹ (Ï† p) x)}
      â†’ (Î» x â†’ âˆ‘ x (Î» (p : P) â†’ Î¹ (Ï† p) x)) ï¼ Î¹ (Ï† (I e))
  III {e} = dfunext fe (Î» x â†’ from-â‹ pe fe fe ((IIIâ‚€ x  , IIIâ‚ x) , IIIâ‚‚ x))
   where
    module _ (x : X) where

     IIIâ‚€ : (Î£ p ê‰ P , is-defined (Î¹ (Ï† p) x))
          â†’ is-defined (Î¹ (Ï† (I e)) x)
     IIIâ‚€ (p , d) = transport (Î» - â†’ is-defined (Î¹ (Ï† -) x)) (i p (I e)) d

     IIIâ‚ : is-defined (Î¹ (Ï† (I e)) x)
          â†’ (Î£ p ê‰ P , is-defined (Î¹ (Ï† p) x))
     IIIâ‚ d = I e , d

     IIIâ‚‚ : (Ïƒ : Î£ p ê‰ P , is-defined (Î¹ (Ï† p) x))
          â†’ value (âˆ‘ x {P , i} (Î» (p : P) â†’ Î¹ (Ï† p) x)) Ïƒ
          ï¼ value (Î¹ (Ï† (I e)) x) (IIIâ‚€ Ïƒ)
     IIIâ‚‚ (p , d) =
      value (âˆ‘ x {P , i} (Î» (p : P) â†’ Î¹ (Ï† p) x)) (p , d) ï¼âŸ¨by-definitionâŸ©
      value (Î¹ (Ï† p) x) d                                 ï¼âŸ¨by-definitionâŸ©
      Î½ (p , d)                                           ï¼âŸ¨ IIIâ‚‚â‚€ âŸ©
      Î½ (I e , IIIâ‚€ (p , d))                              ï¼âŸ¨by-definitionâŸ©
      value (Î¹ (Ï† (I e)) x) (IIIâ‚€ (p , d))                âˆ
       where
        Î½ : (Î£ p ê‰ P , is-defined (Î¹ (Ï† p) x)) â†’ K x
        Î½ (p , d) = value (Î¹ (Ï† p) x) d

        IIIâ‚‚â‚€ = ap Î½ (being-defined-is-prop
                       (âˆ‘ x {P , i} (Î» (p : P) â†’ Î¹ (Ï† p) x))
                       (p , d)
                       (I e , IIIâ‚€ (p , d)))

  IV : value (hâ»Â¹ (h l)) âˆ¼ (Î» x â†’ Ï† (I x))
  IV e = to-subtype-ï¼ being-pos-is-prop (III {e})

  V : hâ»Â¹ (h l) ï¼ l
  V = from-â‹ pe fe fe ((I , II) , IV)

A-is-ğ“›G : A â‰ƒ ğ“› G
A-is-ğ“›G = qinveq hâ»Â¹ (h , hâ»Â¹-is-section , hâ»Â¹-is-retraction)

hâ»Â¹-is-hom : is-hom ğ“ ğ“›G hâ»Â¹
hâ»Â¹-is-hom P i Ï† = IV
 where
  I : (âˆƒ x ê‰ X , Î£ p ê‰ P , is-defined (Ï† p x))
    â†’ (Î£ p ê‰ P , âˆƒ x ê‰ X , is-defined (Ï† p x))
  I = âˆ¥âˆ¥-rec (Î£-is-prop i (Î» _ â†’ âˆƒ-is-prop)) (Î» (x , p , d) â†’ p , âˆ£ x , d âˆ£)

  II : (Î£ p ê‰ P , âˆƒ x ê‰ X , is-defined (Ï† p x))
     â†’ (âˆƒ x ê‰ X , Î£ p ê‰ P , is-defined (Ï† p x))
  II (p , e) = âˆ¥âˆ¥-functor (Î» (x , d) â†’ x , p , d) e

  III : value (hâ»Â¹ (âˆ i Ï†)) âˆ¼ (Î» x â†’ value (â¨† i (hâ»Â¹ âˆ˜ Ï†)) (I x))
  III e = IIIâ‚
   where
    p : P
    p = prâ‚ (I e)

    IIIâ‚€ : âˆ i Ï† ï¼ Ï† p
    IIIâ‚€ = ğ“›-alg-Lawâ‚€-givesâ‚€' pe fe fe âˆ (ğ“›-alg-lawâ‚€ ğ“) P i Ï† p

    IIIâ‚ : (âˆ i Ï† , e) ï¼ (Ï† p , prâ‚‚ (I e))
    IIIâ‚ = to-subtype-ï¼ being-pos-is-prop IIIâ‚€

  IV : hâ»Â¹ (âˆ i Ï†) ï¼ â¨† i (hâ»Â¹ âˆ˜ Ï†)
  IV = from-â‹ pe fe fe ((I , II) , III)

\end{code}

So the product (A , ğ“) of the free algebras is itself free, with
insertion of generators Î¹ : G â†’ A.

\begin{code}

A-is-free-ğ“›-alg : is-free-ğ“›-alg ğ“ G Î¹
A-is-free-ğ“›-alg = ğ“›-alg-isomorphic-to-free-ğ“›-alg-is-itself-free pe fe
                   A-is-set
                   G
                   G-is-set
                   Î¹
                   ğ“
                   hâ»Â¹
                   hâ»Â¹-is-section
                   hâ»Â¹-is-retraction
                   hâ»Â¹-is-hom
\end{code}
